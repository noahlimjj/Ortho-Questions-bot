name: Generate Daily Orthopedic Questions

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering for testing

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-questions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Generate questions
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: node scripts/generate-questions.js

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Add daily generated orthopedic questions

            ü§ñ Auto-generated questions via Perplexity API

            Co-Authored-By: Ortho Quiz Bot <noreply@github.com>
          branch: auto-questions/${{ github.run_number }}
          delete-branch: true
          title: 'üè• Daily Questions: ${{ github.run_number }}'
          body: |
            ## Automated Question Generation ü§ñ

            This PR contains newly generated orthopedic questions.

            ### Summary
            - **Run Date**: ${{ github.event.repository.updated_at }}
            - **Workflow**: Daily Questions Generator
            - **Source**: Perplexity API (llama-3.1-sonar-large-128k-online)

            ### Automated Review
            This PR will be automatically reviewed by Claude API.
            - Questions scoring ‚â• 9.0/10 will be kept
            - Questions scoring < 9.0/10 will be removed
            - PR will auto-merge if any questions pass validation

            ---

            *This PR was automatically created by the Daily Questions workflow.*
            *Awaiting automated review and validation...*
          labels: |
            automated
            questions
            needs-review
          assignees: ${{ github.repository_owner }}

      - name: Wait for PR to be created
        if: steps.create-pr.outputs.pull-request-number != ''
        run: sleep 5

      - name: Trigger Automated Review
        if: steps.create-pr.outputs.pull-request-number != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: node scripts/review-pr.js
